<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/toast.js"></script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Orders Management | TeamAlpha</title>

    <!-- favicons Icons -->
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="assets/images/favicons/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="assets/images/favicons/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="assets/images/favicons/favicon-16x16.png"
    />
    <link rel="manifest" href="assets/images/favicons/site.webmanifest" />
    <meta name="description" content="Orders Management - TeamAlpha" />

    <!-- fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@200;300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Parisienne&display=swap"
      rel="stylesheet"
    />

    <!-- CSS Files -->
    <link
      rel="stylesheet"
      href="assets/vendors/bootstrap/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="assets/vendors/animate/animate.min.css" />
    <link rel="stylesheet" href="assets/vendors/animate/custom-animate.css" />
    <link rel="stylesheet" href="assets/vendors/fontawesome/css/all.min.css" />
    <link rel="stylesheet" href="assets/vendors/jarallax/jarallax.css" />
    <link
      rel="stylesheet"
      href="assets/vendors/jquery-magnific-popup/jquery.magnific-popup.css"
    />
    <link
      rel="stylesheet"
      href="assets/vendors/nouislider/nouislider.min.css"
    />
    <link
      rel="stylesheet"
      href="assets/vendors/nouislider/nouislider.pips.css"
    />
    <link rel="stylesheet" href="assets/vendors/odometer/odometer.min.css" />
    <link rel="stylesheet" href="assets/vendors/swiper/swiper.min.css" />
    <link rel="stylesheet" href="assets/vendors/mellis-icons/style.css" />
    <link
      rel="stylesheet"
      href="assets/vendors/tiny-slider/tiny-slider.min.css"
    />
    <link rel="stylesheet" href="assets/vendors/reey-font/stylesheet.css" />
    <link
      rel="stylesheet"
      href="assets/vendors/owl-carousel/owl.carousel.min.css"
    />
    <link
      rel="stylesheet"
      href="assets/vendors/owl-carousel/owl.theme.default.min.css"
    />
    <link rel="stylesheet" href="assets/vendors/bxslider/jquery.bxslider.css" />
    <link
      rel="stylesheet"
      href="assets/vendors/bootstrap-select/css/bootstrap-select.min.css"
    />
    <link rel="stylesheet" href="assets/vendors/vegas/vegas.min.css" />
    <link rel="stylesheet" href="assets/vendors/jquery-ui/jquery-ui.css" />
    <link rel="stylesheet" href="assets/vendors/timepicker/timePicker.css" />
    <link
      rel="stylesheet"
      href="assets/vendors/twenty-twenty/twentytwenty.css"
    />

    <!-- template styles -->
    <link rel="stylesheet" href="assets/css/mellis.css" />
    <link rel="stylesheet" href="assets/css/mellis-responsive.css" />

    <style>
      /* Header/navbar styles */
      .main-menu__logo img {
        max-height: 48px;
        width: auto;
        display: block;
      }
      .main-menu__list > li > a,
      .main-menu__list > li > a:visited,
      .main-menu__list > li > a:active,
      .main-menu__list > li > a:focus {
        color: #fff !important;
      }
      .main-menu__list > li > a:hover {
        color: #ffb347 !important;
      }
      .main-menu__list .dropdown > a:after,
      .main-menu__list .dropdown > a:before {
        color: #fff !important;
      }
      .main-menu-two__search,
      .main-menu-two__cart,
      .main-menu-two__search-box a,
      .main-menu-two__cart-box a,
      .main-menu-two__search-box .icon-magnifying-glass,
      .main-menu-two__cart-box .icon-shopping-cart,
      .main-menu-two__search-box i,
      .main-menu-two__cart-box i {
        color: #fff !important;
      }
      .main-menu__list ul li a {
        color: #fff !important;
      }
      .main-menu__list ul li a:hover {
        color: #ffb347 !important;
      }
      .mobile-nav__toggler i {
        color: #fff !important;
      }
      .main-header-two,
      .main-menu.main-menu-two,
      .main-menu-two__wrapper,
      .stricky-header.stricked-menu.main-menu.main-menu-two,
      .sticky-header__content {
        background: #23232a !important;
      }
      .main-header-two,
      .stricky-header.stricked-menu.main-menu.main-menu-two {
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        margin-bottom: 32px;
      }
      .main-menu-two__logout-box {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        height: 100%;
      }
      .main-menu-two__logout {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: linear-gradient(90deg, #89868d, #0f0f10);
        color: #fff !important;
        border: none;
        border-radius: 30px;
        padding: 10px 28px 10px 20px;
        font-size: 1rem;
        font-weight: 700;
        letter-spacing: 0.05em;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
        text-decoration: none;
        cursor: pointer;
        position: relative;
        outline: none;
      }
      .main-menu-two__logout i {
        font-size: 1.2em;
        margin-right: 6px;
        transition: color 0.2s;
      }
      .main-menu-two__logout:hover,
      .main-menu-two__logout:focus {
        background: #0f0f10;
        color: #ffb347 !important;
        transform: translateY(-2px) scale(1.04);
        box-shadow: 0 6px 24px rgba(0, 0, 0, 0.14);
        text-decoration: none;
      }
      .main-menu-two__logout:hover i,
      .main-menu-two__logout:focus i {
        color: #ffb347;
      }
      .main-menu__list > li.dropdown ul {
        background-color: #23232a !important;
      }
      .main-menu__list > li.dropdown ul li a {
        color: #fff !important;
        text-align: left;
      }
      .main-menu__list > li.dropdown ul li a:hover {
        color: #ffb347 !important;
      }

      /* Orders Page Styles */
      .orders-section {
        padding: 200px 0 40px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        min-height: calc(100vh - 100px);
      }

      .orders-header {
        background: #fff;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 24px;
      }

      .orders-title {
        font-size: 2rem;
        font-weight: 700;
        color: #0f0f10;
        margin-bottom: 8px;
      }

      .orders-subtitle {
        color: #6c757d;
        font-size: 1rem;
      }

      .orders-table {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        overflow: hidden;
      }

      .table {
        margin-bottom: 0;
      }

      .table th {
        background: #f8f9fa;
        border: none;
        padding: 16px;
        font-weight: 600;
        color: #0f0f10;
      }

      .table td {
        border: none;
        padding: 16px;
        vertical-align: middle;
      }

      .table tbody tr:hover {
        background: #f8f9fa;
      }

      .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: capitalize;
      }

      .status-pending {
        background: #fff3cd;
        color: #856404;
      }

      .status-processing {
        background: #cce5ff;
        color: #004085;
      }

      .status-shipped {
        background: #d1ecf1;
        color: #0c5460;
      }

      .status-delivered {
        background: #d4edda;
        color: #155724;
      }

      .status-cancelled {
        background: #f8d7da;
        color: #721c24;
      }

      .btn-status {
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-status:hover {
        transform: translateY(-1px);
      }

      .btn-delete {
        background: #dc3545;
        color: #fff;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-delete:hover {
        background: #c82333;
        transform: translateY(-1px);
      }

      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 200px;
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #ffb347;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #f5c6cb;
      }

      .no-orders {
        text-align: center;
        padding: 40px;
        color: #6c757d;
      }

      @media (max-width: 768px) {
        .orders-section {
          padding: 60px 0 20px;
        }

        .orders-table {
          overflow-x: auto;
        }

        .table th,
        .table td {
          padding: 12px 8px;
          font-size: 0.875rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- ======= Site Header/Navbar Start ======= -->
    <header class="main-header-two">
      <nav class="main-menu main-menu-two">
        <div class="main-menu-two__wrapper">
          <div class="main-menu-two__wrapper-inner">
            <div class="main-menu-two__left">
              <div class="main-menu-two__logo">
                <a href="index.html"
                  ><img src="assets/images/resources/logo-3.svg" alt=""
                /></a>
              </div>
            </div>
            <div class="main-menu-two__main-menu-box">
              <a href="#" class="mobile-nav__toggler"
                ><i class="fa fa-bars"></i
              ></a>
              <ul class="main-menu__list">
                <li>
                  <a href="dashboard.html">Dashboard</a>
                </li>
                <li>
                  <a href="orders.html">Orders</a>
                </li>
                <li class="dropdown">
                  <a href="#">Products</a>
                  <ul>
                    <li><a href="addproduct.html">Add Product</a></li>
                    <li><a href="manageproducts.html">Manage Products</a></li>
                  </ul>
                </li>
                <li class="dropdown">
                  <a href="#">Blogs</a>
                  <ul>
                    <li><a href="addblog.html">Add Blog</a></li>
                    <li><a href="manageblogs.html">Manage Blogs</a></li>
                  </ul>
                </li>
                <li>
                  <a href="users.html">Users</a>
                </li>
              </ul>
            </div>
            <div class="main-menu-two__right">
              <div class="main-menu-two__logout-box">
                <a
                  href="logout.html"
                  class="main-menu-two__logout"
                  title="Logout"
                >
                  <i class="fas fa-sign-out-alt"></i>
                  Logout
                </a>
              </div>
            </div>
          </div>
        </div>
      </nav>
    </header>
    <div class="stricky-header stricked-menu main-menu main-menu-two">
      <div class="sticky-header__content"></div>
    </div>
    <!-- ======= Site Header/Navbar End ======= -->

    <!-- Orders Section -->
    <div class="orders-section">
      <div class="container">
        <!-- Error Message Container -->
        <div
          id="errorContainer"
          class="error-message"
          style="display: none"
        ></div>

        <!-- Orders Header -->
        <div class="orders-header">
          <div class="orders-title">Orders Management</div>
          <div class="orders-subtitle">
            Manage and track all customer orders
          </div>
        </div>

        <!-- Orders Table -->
        <div class="orders-table">
          <div id="ordersContainer">
            <div class="loading">
              <div class="spinner"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="assets/vendors/jquery/jquery-3.6.0.min.js"></script>
    <script src="assets/vendors/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/vendors/fontawesome/js/all.min.js"></script>
    <script src="assets/js/mellis.js"></script>

    <script>
      // Orders management functionality
      class OrdersManager {
        constructor() {
          this.baseUrl = "https://dermaveritas.com/api/orders";
          this.init();
        }

        async init() {
          try {
            await this.loadOrders();
            this.setupLogout();
          } catch (error) {
            this.showError("Failed to load orders");
            console.error("Orders init error:", error);
          }
        }

        async loadOrders() {
          try {
            const response = await fetch(`${this.baseUrl}/all`, {
              credentials: "include",
            });

            if (!response.ok) throw new Error("Failed to fetch orders");

            const data = await response.json();
            this.displayOrders(data.orders);
          } catch (error) {
            console.error("Error loading orders:", error);
            this.showError("Failed to load orders");
          }
        }

        displayOrders(orders) {
          const container = document.getElementById("ordersContainer");

          if (!orders || orders.length === 0) {
            container.innerHTML =
              '<div class="no-orders"><h4>No orders found</h4><p>There are no orders to display.</p></div>';
            return;
          }

          const tableHTML = `
            <table class="table">
              <thead>
                <tr>
                  <th>Order #</th>
                  <th>Customer</th>
                  <th>Products</th>
                  <th>Total</th>
                  <th>Status</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${orders.map((order) => this.createOrderRow(order)).join("")}
              </tbody>
            </table>
          `;

          container.innerHTML = tableHTML;
          this.setupEventListeners();
        }

        createOrderRow(order) {
          const products = order.products
            .map((product) => `${product.name} (${product.quantity})`)
            .join(", ");

          const statusClass = `status-${order.status}`;
          const statusOptions = [
            "pending",
            "processing",
            "shipped",
            "delivered",
            "cancelled",
          ];

          return `
            <tr>
              <td><strong>${order.orderNumber}</strong></td>
              <td>
                <div>${order.userId?.name || "N/A"}</div>
                <small class="text-muted">${
                  order.userId?.email || "N/A"
                }</small>
              </td>
              <td>
                <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                  ${products}
                </div>
              </td>
              <td><strong>$${order.totalAmount.toFixed(2)}</strong></td>
              <td>
                <span class="status-badge ${statusClass}">${order.status}</span>
              </td>
              <td>${this.formatDate(order.createdAt)}</td>
              <td>
                <select class="btn-status" data-order-id="${
                  order._id
                }" data-current-status="${order.status}">
                  ${statusOptions
                    .map(
                      (status) =>
                        `<option value="${status}" ${
                          status === order.status ? "selected" : ""
                        }>${status}</option>`
                    )
                    .join("")}
                </select>
                <button class="btn-delete" data-order-id="${order._id}">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          `;
        }

        setupEventListeners() {
          // Status change listeners
          document.querySelectorAll(".btn-status").forEach((select) => {
            select.addEventListener("change", async (e) => {
              const orderId = e.target.dataset.orderId;
              const newStatus = e.target.value;
              const currentStatus = e.target.dataset.currentStatus;

              if (newStatus === currentStatus) return;

              try {
                await this.updateOrderStatus(orderId, newStatus);
                e.target.dataset.currentStatus = newStatus;
                this.showSuccess("Order status updated successfully");
              } catch (error) {
                console.error("Error updating order status:", error);
                this.showError("Failed to update order status");
                // Reset to previous status
                e.target.value = currentStatus;
              }
            });
          });

          // Delete listeners
          document.querySelectorAll(".btn-delete").forEach((button) => {
            button.addEventListener("click", async (e) => {
              const orderId = e.target.closest(".btn-delete").dataset.orderId;

              if (confirm("Are you sure you want to delete this order?")) {
                try {
                  await this.deleteOrder(orderId);
                  this.showSuccess("Order deleted successfully");
                  await this.loadOrders(); // Reload the table
                } catch (error) {
                  console.error("Error deleting order:", error);
                  this.showError("Failed to delete order");
                }
              }
            });
          });
        }

        async updateOrderStatus(orderId, status) {
          const response = await fetch(`${this.baseUrl}/${orderId}/status`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include",
            body: JSON.stringify({ status }),
          });

          if (!response.ok) {
            throw new Error("Failed to update order status");
          }

          return response.json();
        }

        async deleteOrder(orderId) {
          const response = await fetch(`${this.baseUrl}/${orderId}`, {
            method: "DELETE",
            credentials: "include",
          });

          if (!response.ok) {
            throw new Error("Failed to delete order");
          }

          return response.json();
        }

        formatDate(dateString) {
          const date = new Date(dateString);
          return date.toLocaleDateString("en-US", {
            year: "numeric",
            month: "short",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });
        }

        showError(message) {
          const errorContainer = document.getElementById("errorContainer");
          errorContainer.textContent = message;
          errorContainer.style.display = "block";

          setTimeout(() => {
            errorContainer.style.display = "none";
          }, 5000);
        }

        showSuccess(message) {
          // Create a temporary success message
          const successDiv = document.createElement("div");
          successDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #d4edda;
            color: #155724;
            padding: 12px 20px;
            border-radius: 8px;
            border: 1px solid #c3e6cb;
            z-index: 1000;
            animation: slideIn 0.3s ease;
          `;
          successDiv.textContent = message;
          document.body.appendChild(successDiv);

          setTimeout(() => {
            successDiv.remove();
          }, 3000);
        }

        setupLogout() {
          const logoutBtn = document.querySelector(".main-menu-two__logout");
          if (logoutBtn) {
            logoutBtn.addEventListener("click", async function (e) {
              e.preventDefault();

              try {
                const response = await fetch(
                  "https://dermaveritas.com/api/users/admin-logout",
                  {
                    method: "GET",
                    credentials: "include",
                  }
                );

                if (response.ok) {
                  toast.success("Logged out successfully!");
                  window.location.href = "index.html";
                } else {
                  const data = await response.json();
                  toast.error(data.message || "Failed to logout.");
                }
              } catch (error) {
                console.error("Logout error:", error);
                toast.error("Error during logout. Please try again.");
              }
            });
          }
        }
      }

      // Initialize orders manager when DOM is loaded
      document.addEventListener("DOMContentLoaded", function () {
        new OrdersManager();
      });
    </script>
  </body>
</html>
