<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edit Product | TeamAlpha</title>
    <!-- favicons and fonts (reuse from addproduct.html) -->
    <link rel="apple-touch-icon" sizes="180x180" href="assets/images/favicons/apple-touch-icon.png"/>
    <link rel="icon" type="image/png" sizes="32x32" href="assets/images/favicons/favicon-32x32.png"/>
    <link rel="icon" type="image/png" sizes="16x16" href="assets/images/favicons/favicon-16x16.png"/>
    <link rel="manifest" href="assets/images/favicons/site.webmanifest"/>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Parisienne&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="assets/vendors/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="assets/vendors/fontawesome/css/all.min.css"/>
    <link rel="stylesheet" href="assets/css/mellis.css"/>
    <link rel="stylesheet" href="assets/css/mellis-responsive.css"/>
    <style>
      /* ...copy styles from addproduct.html... */
      .add-product-section {
        padding: 100px 0;
        background: linear-gradient(135deg, #fcf5f5 0%, #fff 100%);
        min-height: 100vh;
        margin-top: 48px;
      }
      .add-product-container {
        width: 100%;
        max-width: 900px;
        margin-left: auto;
        margin-right: auto;
        background: #fff;
        border-radius: 24px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        padding: 50px 40px;
        position: relative;
        box-sizing: border-box;
      }
      .add-product-title {
        font-family: "Poppins", sans-serif;
        font-size: 2.5rem;
        font-weight: 700;
        color: #0f0f10;
        margin-bottom: 10px;
        text-align: center;
      }
      .add-product-subtitle {
        color: #89868d;
        font-size: 1.1rem;
        text-align: center;
        margin-bottom: 35px;
        font-family: "Inter", sans-serif;
      }
      .add-product-form label {
        font-weight: 600;
        color: #0f0f10;
        margin-bottom: 7px;
        font-size: 1rem;
        font-family: "Poppins", sans-serif;
      }
      .add-product-form input,
      .add-product-form textarea,
      .add-product-form select {
        border-radius: 10px;
        border: 1px solid #f0e8e8;
        background: #fcf5f5;
        padding: 14px 18px;
        font-size: 1rem;
        color: #333;
        margin-bottom: 18px;
        width: 100%;
        font-family: "Inter", sans-serif;
        transition: border-color 0.2s;
        box-sizing: border-box;
      }
      .add-product-form input:focus,
      .add-product-form textarea:focus,
      .add-product-form select:focus {
        border-color: #89868d;
        outline: none;
      }
      .add-product-form .form-row {
        display: flex;
        gap: 20px;
      }
      .add-product-form .form-row > div {
        flex: 1;
      }
      .add-product-form .ingredients-group {
        margin-bottom: 18px;
      }
      .add-product-form .ingredient-row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }
      .add-product-form .ingredient-row input {
        flex: 1;
        margin-bottom: 0;
      }
      .add-product-form .ingredient-row button {
        background: #89868d;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 0 12px;
        font-size: 1.2rem;
        cursor: pointer;
        transition: background 0.2s;
      }
      .add-product-form .ingredient-row button:hover {
        background: #0f0f10;
      }
      .add-product-form .add-ingredient-btn {
        background: #fff;
        color: #89868d;
        border: 1px solid #89868d;
        border-radius: 8px;
        padding: 6px 18px;
        font-size: 1rem;
        font-weight: 600;
        margin-top: 5px;
        margin-bottom: 24px;
        cursor: pointer;
        transition: background 0.2s, color 0.2s;
        display: block;
        width: auto;
      }
      .custom-image-upload {
        border: 2px dashed #89868d;
        border-radius: 14px;
        background: #fcf5f5;
        padding: 32px 20px;
        text-align: center;
        margin-bottom: 18px;
        cursor: pointer;
        transition: border-color 0.2s;
        position: relative;
      }
      .custom-image-upload:hover {
        border-color: #0f0f10;
      }
      .custom-image-upload input[type="file"] {
        display: none;
      }
      .custom-image-upload .upload-icon {
        font-size: 2.5rem;
        color: #89868d;
        margin-bottom: 10px;
        display: block;
      }
      .custom-image-upload .upload-text {
        color: #0f0f10;
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 4px;
      }
      .custom-image-upload .upload-hint {
        color: #89868d;
        font-size: 0.95rem;
      }
      .custom-image-upload .selected-images {
        margin-top: 12px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
      }
      .custom-image-upload .selected-images img {
        width: 48px;
        height: 48px;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid #eee;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      }
      .add-product-form .form-actions {
        text-align: center;
        margin-top: 30px;
      }
      .add-product-form .submit-btn {
        background: linear-gradient(90deg, #89868d, #0f0f10);
        color: #fff;
        border: none;
        border-radius: 50px;
        padding: 16px 50px;
        font-size: 1.1rem;
        font-weight: 700;
        letter-spacing: 0.1em;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        transition: background 0.2s, transform 0.2s;
        cursor: pointer;
      }
      .add-product-form .submit-btn:hover {
        background: #0f0f10;
        transform: translateY(-2px);
      }
      @media (max-width: 600px) {
        .add-product-container {
          padding: 30px 10px;
        }
        .add-product-title {
          font-size: 2rem;
        }
        .add-product-form .form-row {
          flex-direction: column;
          gap: 0;
        }
      }
      .main-menu__logo img {
        max-height: 48px;
        width: auto;
        display: block;
      }
      .main-menu__list > li > a,
      .main-menu__list > li > a:visited,
      .main-menu__list > li > a:active,
      .main-menu__list > li > a:focus {
        color: #fff !important;
      }
      .main-menu__list > li > a:hover {
        color: #ffb347 !important;
      }
      .main-menu__list .dropdown > a:after,
      .main-menu__list .dropdown > a:before {
        color: #fff !important;
      }
      .main-menu-two__search,
      .main-menu-two__cart,
      .main-menu-two__search-box a,
      .main-menu-two__cart-box a,
      .main-menu-two__search-box .icon-magnifying-glass,
      .main-menu-two__cart-box .icon-shopping-cart,
      .main-menu-two__search-box i,
      .main-menu-two__cart-box i {
        color: #fff !important;
      }
      .main-menu__list ul li a {
        color: #fff !important;
      }
      .main-menu__list ul li a:hover {
        color: #ffb347 !important;
      }
      .mobile-nav__toggler i {
        color: #fff !important;
      }
      .main-header-two,
      .main-menu.main-menu-two,
      .main-menu-two__wrapper,
      .stricky-header.stricked-menu.main-menu.main-menu-two,
      .sticky-header__content {
        background: #23232a !important;
      }
      .main-header-two,
      .stricky-header.stricked-menu.main-menu.main-menu-two {
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        margin-bottom: 32px;
      }
      @media (max-width: 600px) {
        .main-header-two,
        .stricky-header.stricked-menu.main-menu.main-menu-two {
          margin-bottom: 20px;
        }
      }
      .main-menu-two__logout-box {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        height: 100%;
      }
      .main-menu-two__logout {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: linear-gradient(90deg, #89868d, #0f0f10);
        color: #fff !important;
        border: none;
        border-radius: 30px;
        padding: 10px 28px 10px 20px;
        font-size: 1rem;
        font-weight: 700;
        letter-spacing: 0.05em;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
        text-decoration: none;
        cursor: pointer;
        position: relative;
        outline: none;
      }
      .main-menu-two__logout i {
        font-size: 1.2em;
        margin-right: 6px;
        transition: color 0.2s;
      }
      .main-menu-two__logout:hover,
      .main-menu-two__logout:focus {
        background: #0f0f10;
        color: #ffb347 !important;
        transform: translateY(-2px) scale(1.04);
        box-shadow: 0 6px 24px rgba(0, 0, 0, 0.14);
        text-decoration: none;
      }
      .main-menu-two__logout:hover i,
      .main-menu-two__logout:focus i {
        color: #ffb347;
      }
      /* For current images preview */
      .current-images {
        display: flex;
        gap: 10px;
        margin-bottom: 12px;
        flex-wrap: wrap;
      }
      .current-images img {
        width: 48px;
        height: 48px;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid #eee;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      }
    </style>
  </head>
  <body>
    <!-- ======= Site Header/Navbar Start ======= -->
    <header class="main-header-two">
      <nav class="main-menu main-menu-two">
        <div class="main-menu-two__wrapper">
          <div class="main-menu-two__wrapper-inner">
            <div class="main-menu-two__left">
              <div class="main-menu-two__logo">
                <a href="index.html"><img src="assets/images/resources/logo-3.svg" alt=""/></a>
              </div>
            </div>
            <div class="main-menu-two__main-menu-box">
              <a href="#" class="mobile-nav__toggler"><i class="fa fa-bars"></i></a>
              <ul class="main-menu__list">
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="orders.html">Orders</a></li>
                <li><a href="addproduct.html">Add Product</a></li>
                <li><a href="manageproducts.html">Manage Products</a></li>
              </ul>
            </div>
            <div class="main-menu-two__right">
              <div class="main-menu-two__logout-box">
                <a href="logout.html" class="main-menu-two__logout" title="Logout">
                  <i class="fas fa-sign-out-alt"></i>
                  Logout
                </a>
              </div>
            </div>
          </div>
        </div>
      </nav>
    </header>
    <div class="stricky-header stricked-menu main-menu main-menu-two">
      <div class="sticky-header__content"></div>
    </div>
    <!-- ======= Site Header/Navbar End ======= -->

    <div class="add-product-section">
      <div class="add-product-container">
        <div class="add-product-title">Edit Product</div>
        <div class="add-product-subtitle">
          Update the details below and save changes.
        </div>
        <form
          class="add-product-form"
          id="editProductForm"
          enctype="multipart/form-data"
          autocomplete="off"
        >
          <label for="name">Product Name *</label>
          <input
            type="text"
            id="name"
            name="name"
            required
            placeholder="Enter product name"
          />

          <label for="description">Description *</label>
          <textarea
            id="description"
            name="description"
            rows="3"
            required
            placeholder="Describe the product"
          ></textarea>

          <div class="form-row">
            <div>
              <label for="price">Price (USD) *</label>
              <input
                type="number"
                id="price"
                name="price"
                min="0"
                step="0.01"
                required
                placeholder="e.g. 19.99"
              />
            </div>
            <div>
              <label for="stockQuantity">Stock Quantity *</label>
              <input
                type="number"
                id="stockQuantity"
                name="stockQuantity"
                min="0"
                required
                placeholder="e.g. 100"
              />
            </div>
          </div>

          <div class="form-row">
            <div>
              <label for="category">Category *</label>
              <input
                type="text"
                id="category"
                name="category"
                required
                placeholder="e.g. Skincare"
              />
            </div>
            <div>
              <label for="servingSize">Serving Size *</label>
              <input
                type="text"
                id="servingSize"
                name="servingSize"
                required
                placeholder="e.g. 50ml"
              />
            </div>
          </div>

          <label for="howToUse">How to Use</label>
          <textarea
            id="howToUse"
            name="howToUse"
            rows="2"
            placeholder="Instructions for use"
          ></textarea>

          <label>Ingredients *</label>
          <div class="ingredients-group" id="ingredientsGroup">
            <!-- Ingredients will be filled by JS -->
          </div>
          <button
            type="button"
            class="add-ingredient-btn"
            id="addIngredientBtn"
          >
            + Add Ingredient
          </button>

          <label for="images">Product Images</label>
          <div class="current-images" id="currentImages"></div>
          <div class="custom-image-upload" id="customImageUpload">
            <span class="upload-icon"
              ><i class="fas fa-cloud-upload-alt"></i
            ></span>
            <span class="upload-text">Click or drag images here to upload (optional)</span>
            <span class="upload-hint"
              >You can select multiple images (JPG, PNG, etc.)<br>
              <b>Leave empty to keep current images.</b>
            </span>
            <input
              type="file"
              id="images"
              name="images"
              accept="image/*"
              multiple
            />
            <div class="selected-images" id="selectedImages"></div>
          </div>

          <div class="form-actions">
            <button type="submit" class="submit-btn">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
    <script>
      // Get product ID from URL
      function getProductIdFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get("id");
      }

      // Fill form with product data
      async function fetchAndFillProduct() {
        const id = getProductIdFromUrl();
        if (!id) {
          alert("No product ID specified.");
          window.location.href = "manageproducts.html";
          return;
        }
        try {
          const res = await fetch(`http://localhost:3000/api/products/${id}`);
          const data = await res.json();
          if (!data.success || !data.product) throw new Error("Product not found");
          const p = data.product;
          document.getElementById("name").value = p.name || "";
          document.getElementById("description").value = p.description || "";
          document.getElementById("price").value = p.price || "";
          document.getElementById("stockQuantity").value = p.stockQuantity || "";
          document.getElementById("category").value = p.category || "";
          document.getElementById("servingSize").value = p.servingSize || "";
          document.getElementById("howToUse").value = p.howToUse || "";

          // Fill ingredients
          const group = document.getElementById("ingredientsGroup");
          group.innerHTML = "";
          if (Array.isArray(p.ingredients) && p.ingredients.length > 0) {
            p.ingredients.forEach(ing => {
              const row = document.createElement("div");
              row.className = "ingredient-row";
              row.innerHTML = `
                <input type="text" name="ingredientName[]" placeholder="Ingredient name" required value="${ing.name || ""}" />
                <input type="text" name="ingredientQuantity[]" placeholder="Quantity (e.g. 10mg)" required value="${ing.quantity || ""}" />
                <button type="button" class="remove-ingredient" title="Remove">&times;</button>
              `;
              group.appendChild(row);
            });
          } else {
            // At least one row
            const row = document.createElement("div");
            row.className = "ingredient-row";
            row.innerHTML = `
              <input type="text" name="ingredientName[]" placeholder="Ingredient name" required />
              <input type="text" name="ingredientQuantity[]" placeholder="Quantity (e.g. 10mg)" required />
              <button type="button" class="remove-ingredient" title="Remove">&times;</button>
            `;
            group.appendChild(row);
          }

          // Show current images
          const currentImagesDiv = document.getElementById("currentImages");
          currentImagesDiv.innerHTML = "";
          if (Array.isArray(p.images) && p.images.length > 0) {
            p.images.forEach(img => {
              const image = document.createElement("img");
              image.src = img.url;
              image.alt = img.altText || "";
              currentImagesDiv.appendChild(image);
            });
          }
        } catch (err) {
          alert("Failed to load product.");
          window.location.href = "manageproducts.html";
        }
      }

      // Ingredient dynamic add/remove
      document.getElementById("addIngredientBtn").addEventListener("click", function () {
        const group = document.getElementById("ingredientsGroup");
        const row = document.createElement("div");
        row.className = "ingredient-row";
        row.innerHTML = `
          <input type="text" name="ingredientName[]" placeholder="Ingredient name" required />
          <input type="text" name="ingredientQuantity[]" placeholder="Quantity (e.g. 10mg)" required />
          <button type="button" class="remove-ingredient" title="Remove">&times;</button>
        `;
        group.appendChild(row);
      });
      document.getElementById("ingredientsGroup").addEventListener("click", function (e) {
        if (e.target.classList.contains("remove-ingredient")) {
          const rows = document.querySelectorAll(".ingredient-row");
          if (rows.length > 1) e.target.parentElement.remove();
        }
      });

      // Custom image upload preview
      const customUpload = document.getElementById("customImageUpload");
      const fileInput = document.getElementById("images");
      const selectedImages = document.getElementById("selectedImages");

      customUpload.addEventListener("click", function (e) {
        if (e.target !== fileInput) fileInput.click();
      });

      customUpload.addEventListener("dragover", function (e) {
        e.preventDefault();
        customUpload.style.borderColor = "#0f0f10";
      });
      customUpload.addEventListener("dragleave", function (e) {
        e.preventDefault();
        customUpload.style.borderColor = "#89868d";
      });
      customUpload.addEventListener("drop", function (e) {
        e.preventDefault();
        customUpload.style.borderColor = "#89868d";
        fileInput.files = e.dataTransfer.files;
        showSelectedImages();
      });

      fileInput.addEventListener("change", showSelectedImages);

      function showSelectedImages() {
        selectedImages.innerHTML = "";
        const files = fileInput.files;
        if (!files.length) return;
        Array.from(files).forEach((file) => {
          if (file.type.startsWith("image/")) {
            const reader = new FileReader();
            reader.onload = function (e) {
              const img = document.createElement("img");
              img.src = e.target.result;
              selectedImages.appendChild(img);
            };
            reader.readAsDataURL(file);
          }
        });
      }

      // Form submit handler
      document.getElementById("editProductForm").addEventListener("submit", async function (e) {
        e.preventDefault();
        const id = getProductIdFromUrl();
        if (!id) {
          alert("No product ID specified.");
          return;
        }
        const form = e.target;
        const formData = new FormData();

        // Gather fields
        formData.append("name", form.name.value);
        formData.append("description", form.description.value);
        formData.append("price", form.price.value);
        formData.append("stockQuantity", form.stockQuantity.value);
        formData.append("category", form.category.value);
        formData.append("servingSize", form.servingSize.value);
        formData.append("howToUse", form.howToUse.value);

        // Gather ingredients as array of objects
        const ingredientNames = Array.from(form.querySelectorAll('input[name="ingredientName[]"]')).map(i => i.value);
        const ingredientQuantities = Array.from(form.querySelectorAll('input[name="ingredientQuantity[]"]')).map(i => i.value);
        const ingredients = [];
        for (let i = 0; i < ingredientNames.length; i++) {
          if (ingredientNames[i] && ingredientQuantities[i]) {
            ingredients.push({
              name: ingredientNames[i],
              quantity: ingredientQuantities[i],
            });
          }
        }
        formData.append("ingredients", JSON.stringify(ingredients));

        // Images (optional)
        if (fileInput.files.length > 0) {
          for (let i = 0; i < fileInput.files.length; i++) {
            formData.append("images", fileInput.files[i]);
          }
        }

        try {
          const response = await fetch(`http://localhost:3000/api/products/${id}`, {
            method: "PUT",
            body: formData,
            credentials: "include"
          });
          const data = await response.json();
          if (response.ok) {
            alert("Product updated successfully!");
            window.location.href = "manageproducts.html";
          } else {
            alert(data.message || "Failed to update product.");
          }
        } catch (err) {
          alert("Error: " + err.message);
        }
      });

      // Initial fetch
      fetchAndFillProduct();
    </script>
    <script src="assets/vendors/jquery/jquery-3.6.0.min.js"></script>
    <script src="assets/vendors/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/vendors/fontawesome/js/all.min.js"></script>
    <script src="assets/js/mellis.js"></script>
  </body>
</html>
